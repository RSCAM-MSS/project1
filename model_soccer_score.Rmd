---
title: "Modeling outcomes of soccer matches"
output:
  html_document:
    df_print: paged
---

```{r include=FALSE}
library(tidyverse)
```


### Read Data


```{r}
data <- read.table("data/ISDBv2.0.txt",sep="\t",header=TRUE)

data
```
### Data exploration

```{r}
data %>% separate(Lge, c("LgeName"), 3, remove = FALSE) %>%
  ggplot(aes(LgeName, weight=1/1000)) + geom_bar(color="black",fill="gray",width=.75) + 
  labs(
    x = "Country",
    y = "Number of matches (thousands)",
    title = "Fig 1: Number of available matches per country in the data"
  ) +
  theme_classic() +
  theme(
    axis.text.x=element_text(angle=90, hjust=1)
  )
```


```{r}
hg <- data %>% select(-c("GD","WDL")) %>% 
  pivot_longer(
    c("HS","AS"),
    names_to = "Home",
    values_to = "Goal"
  ) %>% 
  mutate(
    Home = ordered(Home, levels=c("HS","AS"))
  ) 

hg %>% 
  ggplot(aes(Goal,weight=1/1000,fill=Home)) + geom_bar(position = "dodge",width = .5,color="black") + 
  labs(
    x = "Number of goals",
    y = "Number of matches (thousands)",
    title = "Fig 2: The number of matches per number of goals scored by the home and away team"
  ) +
  scale_fill_manual(values = c("black","gray")) +
  scale_x_continuous(breaks = 0:11) +
  theme_classic()
  
```

```{r}
data %>% distinct() %>% summarise(
  sumHS = sum(HS),
  sumAS = sum(AS)
)

# The result is different from the paper.
```


### Data cleanning and feature extraction

```{r prep}
# Errors mentioned in the paper has been corrected in the ISDB v2.0.


```



### Modelling outcomes

#### Bradley-Terry models and extensions

The Bradley-Terry model assumes that

$$
p(y_{ijt}=1) = \frac{\pi_{i}}{\pi_{i}+\pi_{j}},
$$
where $\pi_{i}=\text{exp}(\lambda_{i})$, and $\lambda_{i}$ is understood as the “strength” of team $i$.

We consider extensions of the original Bradley- Terry formulation where we allow $\lambda_{i}$ to depend on a $p$-vector of time-dependent features ${\bf x}_{it}$ for team $i$ at time $t$ as $\lambda_{it} = f({x}_{it})$ for some function $f(\cdot)$.

##### Handling draws

1. Ordinal

$$
y_{i j t}=\left\{\begin{array}{l}
2, \quad\text{if team }i\text{ beats team }j\text{ at time }t, \\
1, \quad\text{if team }i\text{ and team }j\text{ draw at time }t,\\
0, \quad\text{if team }j\text{ beats team }i\text{ at time }t.
\end{array}\right.
$$
and assume that $y_{ijt}$ has

$$
p\left(y_{i j t} \leq y\right)=\frac{e^{\delta_{y}+\lambda_{i t}}}{e^{\delta_{y}+\lambda_{i t}}+e^{\lambda_{j t}}}.
$$


2. Davidson

$$
\begin{aligned}
p\left(y_{i j t}=2 \mid y_{i j t} \neq 1\right) &=\frac{\pi_{i t}}{\pi_{i t}+\pi_{j t}}, \\
p\left(y_{i j t}=1\right) &=\frac{\delta \sqrt{\pi_{i t} \pi_{j t}}}{\pi_{i t}+\pi_{j t}+\delta \sqrt{\pi_{i t} \pi_{j t}}}, \\
p\left(y_{i j t}=0 \mid y_{i j t} \neq 1\right) &=\frac{\pi_{j t}}{\pi_{i t}+\pi_{j t}}.
\end{aligned}
$$

##### BL: Base Line

$$
\lambda_{it} = \beta h_{it},
$$
where $h_{it}=1$ if team $i$ is playing at home at time $t$, and $h_{it} = 0$ otherwise.


##### CS: Constant Strengths

$$
\lambda_{it} = \alpha_{i} + \beta h_{it},
$$
where $\alpha_{i}$ represents the time-invariant strength of the $i$th team.


##### LF: Linear with features

$$
\lambda_{it} = \sum_{k=1}^{p}\beta_{k}{\bf x}_{itk},
$$
where $x_{itk}$ is the $k$th element of the feature vector ${\bf x}_{it}$.


##### Estimation

```{r}
# Implement the model on a small data set: 16-17 GER1
# Extract the `Home` feature
trdata <- data %>% filter(Sea=="16-17" & Lge=="GER1") %>%  select(-c("Sea","Lge","HS","AS","GD")) %>% 
  summarise(
    Date = as.numeric(as.Date(Date,"%d/%m/%y")),
    HT = ordered(HT,levels = unique(.data$HT)),
    AT = ordered(AT,levels = unique(.data$HT)),
    H = as.integer(HT),
    A = as.integer(AT),
    WDL = 2*(WDL == "W") + (WDL == "D")
  )

trdata
```

```{r}
hit <- function(i,t,data) {
  ma <- data %>% filter(Date == t & H == i)
  return(nrow(ma))
}

hit(7,18501,trdata)

lit <- function(beta,i,t,data) {
  return(beta*hit(i,t,data))
}
lit(1,1,18500,trdata)

Ord_cdf <- function(y,delta,beta,i,j,t,data) {
  if(y==2) 
    return(1)
  l_it <- lit(beta,i,t,data)
  l_jt <- lit(beta,j,t,data)
  num = exp(delta[y+1]+l_it)
  denom = num + exp(l_jt)
  return(num/denom)
}

Ord_pdf <- function(y,delta,beta,i,j,t,data) {
  case_when(
    y == 2 ~ 1 - Ord_cdf(1,delta,beta,i,j,t,data),
    y == 1 ~ Ord_cdf(1,delta,beta,i,j,t,data) - Ord_cdf(0,delta,beta,i,j,t,data),
    y == 0 ~ Ord_cdf(0,delta,beta,i,j,t,data)
  )
}

Dav_pdf <- function(y,delta,beta,i,j,t,data) {
  piit <- exp(lit(beta,i,t,data))
  pijt <- exp(lit(beta,i,t,data))
  
  num = delta*sqrt(piit*pijt)
  denom = piit + pijt + num
  p1 = num/denom
  
  case_when(
    y == 1 ~ p1,
    y == 0 ~ (1-p1)*pijt/(piit+pijt),
    y == 2 ~ (1-p1)*piit/(piit+pijt)
  )
}

```

```{r}
# The log-likelihood
ll_BL <- function(theta,data,method_pdf) {
  beta = theta[1]
  delta = theta[-1]
  
  N = nrow(data)
  ll <- 0
  
  for (k in 1:N) {
    ma = data[k,]
    i = ma$H
    j = ma$A
    t = ma$Date
    y = ma$WDL
    
    ll = ll + log10(method_pdf(y,delta,beta,i,j,t,data))
  }
  
  return(ll)
}
```

```{r}
# Find the optimal solution
init <- c(1,0.5)
optim(par=init,fn=ll_BL,data=trdata,method_pdf=Dav_pdf,method="BFGS",control=list(fnscale=-1))
```

